<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FO4 Achievement Checklist</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #eee; }
    h2 { border-bottom: 1px solid #444; margin-top: 2rem; }
    label { display: flex; align-items: center; margin: 0.5rem 0; }
    input[type="checkbox"] { margin-right: 0.5rem; }
    textarea { width: 100%; height: 60px; margin-top: 4px; background: #222; color: #eee; border: 1px solid #333; }
    .achievement { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dotted #444; }
  </style>
</head>
<body>
  <h1>Fallout 4 Achievement Checklist</h1>
  <p id="status">Loading...</p>
  <label><input type="checkbox" id="hideCheckedToggle"> Hide completed</label>
  <p id="counter"></p>
  <button id="logoutBtn" style="display: none;">Logout</button>
  <div id="checklist"></div>

  <script src="auth.js"></script>
  <script>
    const db = firebase.firestore();
    let userId = null;
    const checklistContainer = document.getElementById("checklist");
    const statusEl = document.getElementById("status");
    const counterEl = document.getElementById("counter");
    const checklistData = {};

    function onUserSignedIn(user) {
      userId = user.uid;
      statusEl.innerText = "Signed in as " + user.email;
      loadChecklist();
    }

    async function loadChecklist() {
      const snapshot = await db.collection("checklists").doc(userId).get();
      if (snapshot.exists) {
        Object.assign(checklistData, snapshot.data());
      }
      renderChecklist();
    }

    async function renderChecklist() {
      try {
        const user = firebase.auth().currentUser;
const idToken = await user.getIdToken(true);

const res = await fetch("https://getachievements-w7vvbovawq-uc.a.run.app", {
  method: "GET",
  headers: {
    "Authorization": "Bearer " + idToken
  }
});

const apiData = await res.json();
        const data = {};

        apiData.achievements.forEach((ach, index) => {
          const category = ach.titleAssociations?.[0]?.name || "Other";
          if (!data[category]) data[category] = [];
          data[category].push({
            id: `${index}`,
            name: ach.name,
            desc: ach.description
          });
        });

        for (const [dlc, items] of Object.entries(data)) {
          const section = document.createElement('section');
          section.innerHTML = `<h2>${dlc}</h2>`;
          items.forEach(item => {
            const box = document.createElement('div');
            box.className = 'achievement';
            box.innerHTML = `
              <label><input type="checkbox" id="cb-${item.id}"> ${item.name}</label>
              <div><i>${item.desc}</i></div>
              <textarea id="note-${item.id}" placeholder="Your notes..."></textarea>
            `;
            section.appendChild(box);

            const checkbox = box.querySelector('input[type="checkbox"]');
            const desc = box.querySelector('div');
            const notes = box.querySelector('textarea');

            checkbox.addEventListener('change', () => {
              const hidden = checkbox.checked;
              desc.style.display = hidden ? 'none' : '';
              notes.style.display = hidden ? 'none' : '';
              updateCheckCounter();
            });
          });
          checklistContainer.appendChild(section);
        }

        const toggle = document.getElementById("hideCheckedToggle");
        if (toggle) {
          toggle.addEventListener("change", () => {
            const hideChecked = toggle.checked;
            document.querySelectorAll('.achievement').forEach(box => {
              const cb = box.querySelector('input[type=checkbox]');
              box.style.display = hideChecked && cb.checked ? 'none' : '';
            });
            updateCheckCounter();
          });
          if (toggle.checked) toggle.dispatchEvent(new Event('change'));
        }

        for (const id in checklistData) {
          const item = checklistData[id];
          const cb = document.getElementById("cb-" + id);
          const note = document.getElementById("note-" + id);
          if (cb) {
            cb.checked = item.checked;
            const desc = cb.closest('.achievement').querySelector('div');
            const notes = cb.closest('.achievement').querySelector('textarea');
            const hidden = item.checked;
            if (desc) desc.style.display = hidden ? 'none' : '';
            if (notes) notes.style.display = hidden ? 'none' : '';
          }
          if (note) note.value = item.note || "";
        }

        document.querySelectorAll('input[type=checkbox], textarea').forEach(el => {
          el.addEventListener('change', () => {
            saveProgress();
            if (el.type === "checkbox") updateCheckCounter();
          });
        });

        updateCheckCounter();
      } catch (err) {
        statusEl.innerText = "Error loading checklist: " + err.message;
        console.error("Checklist fetch error:", err);
      }
    }

    function saveProgress() {
      const newData = {};
      document.querySelectorAll('.achievement').forEach(el => {
        const id = el.querySelector('input').id.replace('cb-', '');
        const checked = el.querySelector('input').checked;
        const note = el.querySelector('textarea').value;
        newData[id] = { checked, note };
      });
      db.collection("checklists").doc(userId).set(newData).then(() => {
        statusEl.innerText = "Progress saved.";
      });
    }

    function updateCheckCounter() {
      const total = document.querySelectorAll('.achievement input[type="checkbox"]').length;
      const checked = document.querySelectorAll('.achievement input[type="checkbox"]:checked').length;
      counterEl.innerText = `Completed: ${checked} / ${total}`;
    }
  </script>
</body>
</html>
